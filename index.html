<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½è‚¡ç¥¨å¸‚åœºåˆ†æç³»ç»Ÿ V2.0 - å…¨å¸‚åœºæ‰«æç‰ˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      padding: 20px;
      color: #e4e4e4;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
    }

    .header h1 {
      color: #00d9ff;
      font-size: 2rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header p {
      color: #a0a0a0;
      font-size: 0.95rem;
    }

    .highlight-box {
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(0, 217, 255, 0.05));
      border: 1px solid rgba(0, 217, 255, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }

    .highlight-box h3 {
      color: #00d9ff;
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .highlight-box p {
      color: #8ec8ff;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .status-bar {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .status-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px 20px;
      border-radius: 8px;
      border-left: 4px solid #00d9ff;
    }

    .status-item .label {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 4px;
    }

    .status-item .value {
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
    }

    .main-content {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 25px;
    }

    .card h2 {
      color: #00d9ff;
      font-size: 1.2rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .analyze-btn {
      width: 100%;
      padding: 18px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #1a1a2e;
      background: linear-gradient(135deg, #00d9ff 0%, #00a8cc 100%);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 20px rgba(0, 217, 255, 0.4);
    }

    .analyze-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 217, 255, 0.6);
    }

    .analyze-btn:disabled {
      background: #444;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .analyze-btn .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(26, 26, 46, 0.3);
      border-top-color: #1a1a2e;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .analysis-params {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .param-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .param-group label {
      font-size: 0.85rem;
      color: #aaa;
      font-weight: 500;
    }

    .param-group select,
    .param-group input {
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      font-size: 0.9rem;
      color: #fff;
      transition: all 0.3s;
    }

    .param-group select option {
      background: #1a1a2e;
      color: #fff;
    }

    .param-group select:focus,
    .param-group input:focus {
      outline: none;
      border-color: #00d9ff;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
    }

    .info-box {
      background: rgba(0, 217, 255, 0.1);
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-top: 15px;
    }

    .info-box .label {
      font-size: 0.8rem;
      color: #00d9ff;
      margin-bottom: 5px;
    }

    .info-box .value {
      font-size: 0.9rem;
      color: #8ec8ff;
      line-height: 1.5;
    }

    .progress-section {
      margin-top: 20px;
      display: none;
    }

    .progress-section.active {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00d9ff, #00a8cc);
      width: 0%;
      transition: width 0.3s;
    }

    .progress-text {
      font-size: 0.85rem;
      color: #8ec8ff;
      margin-top: 8px;
    }

    .stock-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .stock-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
    }

    .stock-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: #00d9ff;
      transform: translateX(5px);
    }

    .stock-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .stock-rank {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #00d9ff 0%, #00a8cc 100%);
      color: #1a1a2e;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: bold;
      margin-right: 15px;
    }

    .stock-rank.top3 {
      background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
    }

    .stock-main-info {
      flex: 1;
    }

    .stock-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .stock-code {
      font-size: 0.85rem;
      color: #888;
      font-family: 'Courier New', monospace;
    }

    .stock-price-info {
      text-align: right;
    }

    .stock-price {
      font-size: 1.3rem;
      font-weight: bold;
      color: #fff;
    }

    .stock-change {
      font-size: 0.9rem;
      margin-top: 4px;
    }

    .stock-change.up {
      color: #ff4757;
    }

    .stock-change.down {
      color: #2ed573;
    }

    .stock-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 15px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .metric-item {
      text-align: center;
    }

    .metric-label {
      font-size: 0.75rem;
      color: #888;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: #00d9ff;
    }

    .stock-prediction {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(0, 168, 204, 0.1));
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .prediction-label {
      font-size: 0.85rem;
      color: #aaa;
    }

    .prediction-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2ed573;
    }

    .win-probability {
      font-size: 1.2rem;
      font-weight: bold;
      color: #ffd700;
    }

    .stock-reasons {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 15px;
    }

    .stock-reasons h4 {
      font-size: 0.85rem;
      color: #00d9ff;
      margin-bottom: 10px;
    }

    .stock-reasons ul {
      list-style: none;
      padding: 0;
    }

    .stock-reasons li {
      font-size: 0.85rem;
      color: #aaa;
      line-height: 1.6;
      padding: 5px 0;
      padding-left: 20px;
      position: relative;
    }

    .stock-reasons li::before {
      content: 'âœ“';
      position: absolute;
      left: 0;
      color: #2ed573;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .error-box {
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid rgba(255, 71, 87, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .error-box h3 {
      color: #ff4757;
      margin-bottom: 10px;
    }

    .error-box p {
      color: #ff8a8a;
      line-height: 1.6;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-content {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(0, 217, 255, 0.2);
      border-top-color: #00d9ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .loading-text {
      font-size: 1.2rem;
      color: #fff;
      margin-bottom: 10px;
    }

    .loading-subtext {
      font-size: 0.9rem;
      color: #8ec8ff;
    }

    .loading-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .loading-stat {
      text-align: center;
    }

    .loading-stat .number {
      font-size: 1.5rem;
      font-weight: bold;
      color: #00d9ff;
    }

    .loading-stat .label {
      font-size: 0.8rem;
      color: #888;
    }

    .loading-progress {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin-top: 20px;
      overflow: hidden;
    }

    .loading-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00d9ff, #00a8cc);
      width: 0%;
      transition: width 0.5s;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <h1>
        <span>ğŸ“Š</span>
        æ™ºèƒ½è‚¡ç¥¨å¸‚åœºåˆ†æç³»ç»Ÿ V2.0
      </h1>
      <p>å…¨å¸‚åœºæ‰«æç‰ˆ - ä»Aè‚¡å…¨éƒ¨5000+è‚¡ç¥¨ä¸­æ™ºèƒ½ç­›é€‰æœ€ä¼˜æ ‡çš„</p>
      
      <div class="highlight-box">
        <h3>ğŸš€ V2.0 å…¨æ–°å‡çº§</h3>
        <p>
          âœ… <strong>å…¨å¸‚åœºæ‰«æ</strong>ï¼šä»æ²ªæ·±ä¸¤å¸‚å…¨éƒ¨è‚¡ç¥¨ä¸­åˆ†æç­›é€‰ï¼Œè€Œéå›ºå®šè‚¡ç¥¨æ± <br>
          âœ… <strong>å®æ—¶æ•°æ®</strong>ï¼šä½¿ç”¨ä¸œæ–¹è´¢å¯ŒAPIè·å–çœŸå®è¡Œæƒ…ï¼Œæ— æ¨¡æ‹Ÿæ•°æ®<br>
          âœ… <strong>æ™ºèƒ½æ’åº</strong>ï¼šå¤šç»´åº¦è¯„åˆ†ç®—æ³•ï¼Œç­›é€‰æœ€å…·ä¸Šæ¶¨æ½œåŠ›çš„è‚¡ç¥¨
        </p>
      </div>
      
      <div class="status-bar">
        <div class="status-item">
          <div class="label">ç³»ç»ŸçŠ¶æ€</div>
          <div class="value" id="systemStatus">å°±ç»ª</div>
        </div>
        <div class="status-item">
          <div class="label">æ•°æ®æ›´æ–°</div>
          <div class="value" id="updateTime">--</div>
        </div>
        <div class="status-item">
          <div class="label">æ‰«æèŒƒå›´</div>
          <div class="value" id="scanRange">å…¨å¸‚åœº 5000+ è‚¡ç¥¨</div>
        </div>
        <div class="status-item">
          <div class="label">å¸‚åœºçŠ¶æ€</div>
          <div class="value" id="marketStatus">--</div>
        </div>
      </div>
    </div>

    <div class="main-content">
      <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
      <div class="card">
        <h2>ğŸ¯ åˆ†æå‚æ•°</h2>
        
        <div class="analysis-params">
          <div class="param-group">
            <label>æ‰«æå¸‚åœº</label>
            <select id="marketSelect">
              <option value="all">å…¨éƒ¨Aè‚¡ï¼ˆæ²ªæ·±ä¸¤å¸‚ï¼‰</option>
              <option value="sh">ä»…ä¸Šæµ·å¸‚åœº</option>
              <option value="sz">ä»…æ·±åœ³å¸‚åœº</option>
              <option value="cyb">åˆ›ä¸šæ¿</option>
              <option value="kcb">ç§‘åˆ›æ¿</option>
            </select>
          </div>

          <div class="param-group">
            <label>åˆ†æç»´åº¦</label>
            <select id="dimensionSelect">
              <option value="comprehensive">ç»¼åˆåˆ†æï¼ˆæ¨èï¼‰</option>
              <option value="momentum">åŠ¨é‡ç­–ç•¥</option>
              <option value="reversal">åè½¬ç­–ç•¥</option>
              <option value="volume">é‡èƒ½çªç ´</option>
            </select>
          </div>

          <div class="param-group">
            <label>ç­›é€‰æ¡ä»¶</label>
            <select id="filterSelect">
              <option value="all">æ— é™åˆ¶</option>
              <option value="exclude_st">æ’é™¤STè‚¡</option>
              <option value="main_only">ä»…ä¸»æ¿</option>
              <option value="large_cap">å¤§ç›˜è‚¡(>100äº¿)</option>
            </select>
          </div>

          <div class="param-group">
            <label>æ¨èæ•°é‡</label>
            <select id="stockCount">
              <option value="8">TOP 8</option>
              <option value="10">TOP 10</option>
              <option value="15">TOP 15</option>
              <option value="20">TOP 20</option>
            </select>
          </div>
        </div>

        <button class="analyze-btn" id="analyzeBtn">
          <span>ğŸš€ å¼€å§‹å…¨å¸‚åœºæ‰«æ</span>
        </button>

        <div class="info-box">
          <div class="label">ğŸ“Š æ•°æ®æ¥æº</div>
          <div class="value" id="dataSourceLabel">ä¸œæ–¹è´¢å¯Œå®æ—¶è¡Œæƒ…API</div>
        </div>

        <div class="progress-section" id="progressSection">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">å‡†å¤‡æ‰«æ...</div>
        </div>
      </div>

      <!-- å³ä¾§ç»“æœåŒºåŸŸ -->
      <div class="card">
        <h2>ğŸ† ç­›é€‰ç»“æœ - æ¬¡æ—¥æ¶¨å¹…æ½œåŠ›è‚¡</h2>
        <div class="stock-list" id="stockList">
          <div class="empty-state">
            <div class="icon">ğŸ“ˆ</div>
            <h3>ç­‰å¾…å¼€å§‹åˆ†æ</h3>
            <p style="margin-top: 10px;">ç‚¹å‡»"å¼€å§‹å…¨å¸‚åœºæ‰«æ"ä»5000+è‚¡ç¥¨ä¸­ç­›é€‰æœ€ä¼˜æ ‡çš„</p>
            <p style="margin-top: 10px; font-size: 0.85rem; color: #666;">
              ç³»ç»Ÿå°†å®æ—¶è·å–å…¨å¸‚åœºè¡Œæƒ…æ•°æ®ï¼Œè¿›è¡Œå¤šç»´åº¦åˆ†æ
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åŠ è½½åŠ¨ç”» -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">æ­£åœ¨æ‰«æå…¨å¸‚åœº...</div>
      <div class="loading-subtext" id="loadingSubtext">è·å–è‚¡ç¥¨åˆ—è¡¨</div>
      <div class="loading-stats">
        <div class="loading-stat">
          <div class="number" id="scannedCount">0</div>
          <div class="label">å·²æ‰«æ</div>
        </div>
        <div class="loading-stat">
          <div class="number" id="totalCount">0</div>
          <div class="label">æ€»è‚¡ç¥¨æ•°</div>
        </div>
        <div class="loading-stat">
          <div class="number" id="qualifiedCount">0</div>
          <div class="label">ç¬¦åˆæ¡ä»¶</div>
        </div>
      </div>
      <div class="loading-progress">
        <div class="loading-progress-fill" id="loadingProgressFill"></div>
      </div>
    </div>
  </div>

  <script>
    // ========== å…¨å±€é…ç½® ==========
    const CONFIG = {
      // ä¸œæ–¹è´¢å¯ŒAPIï¼ˆæ”¯æŒè·å–å…¨å¸‚åœºè‚¡ç¥¨åˆ—è¡¨å’Œå®æ—¶è¡Œæƒ…ï¼‰
      EASTMONEY_LIST_API: 'https://push2.eastmoney.com/api/qt/clist/get',
      // å¤‡ç”¨ï¼šæ–°æµªè´¢ç»API
      SINA_API: 'https://hq.sinajs.cn/list=',
      // CORSä»£ç†åˆ—è¡¨
      CORS_PROXIES: [
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?',
      ],
      // æ¯æ‰¹è·å–æ•°é‡
      BATCH_SIZE: 100,
      // åˆ†æçš„æœ€å¤§è‚¡ç¥¨æ•°é‡ï¼ˆä¸ºäº†æ€§èƒ½ï¼‰
      MAX_ANALYZE_COUNT: 2000,
    };

    // ========== å…¨å±€å˜é‡ ==========
    let analysisInProgress = false;
    let allStocks = []; // å…¨å¸‚åœºè‚¡ç¥¨æ•°æ®
    let currentProxyIndex = 0;

    // ========== åˆå§‹åŒ– ==========
    function init() {
      updateMarketStatus();
      setInterval(updateMarketStatus, 60000);
      document.getElementById('updateTime').textContent = new Date().toLocaleTimeString('zh-CN');
    }

    // ========== æ›´æ–°å¸‚åœºçŠ¶æ€ ==========
    function updateMarketStatus() {
      const now = new Date();
      const hour = now.getHours();
      const minute = now.getMinutes();
      const day = now.getDay();

      let status = 'ä¼‘å¸‚';
      
      if (day >= 1 && day <= 5) {
        if ((hour === 9 && minute >= 30) || (hour >= 10 && hour < 11) || (hour === 11 && minute < 30)) {
          status = 'äº¤æ˜“ä¸­ ğŸŸ¢';
        } else if ((hour >= 13 && hour < 15)) {
          status = 'äº¤æ˜“ä¸­ ğŸŸ¢';
        } else if (hour >= 15) {
          status = 'å·²æ”¶ç›˜ ğŸŸ¡';
        } else if (hour < 9 || (hour === 9 && minute < 30)) {
          status = 'ç›˜å‰ ğŸŸ¡';
        }
      } else {
        status = 'å‘¨æœ«ä¼‘å¸‚ ğŸ”´';
      }

      document.getElementById('marketStatus').textContent = status;
      document.getElementById('updateTime').textContent = now.toLocaleTimeString('zh-CN');
    }

    // ========== è·å–CORSä»£ç†URL ==========
    function getProxyUrl(url) {
      const proxy = CONFIG.CORS_PROXIES[currentProxyIndex];
      return proxy + encodeURIComponent(url);
    }

    // ========== åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä»£ç† ==========
    function switchProxy() {
      currentProxyIndex = (currentProxyIndex + 1) % CONFIG.CORS_PROXIES.length;
      console.log(`åˆ‡æ¢åˆ°ä»£ç† ${currentProxyIndex + 1}: ${CONFIG.CORS_PROXIES[currentProxyIndex]}`);
    }

    // ========== è·å–å…¨å¸‚åœºè‚¡ç¥¨åˆ—è¡¨ï¼ˆä¸œæ–¹è´¢å¯ŒAPIï¼‰==========
    async function fetchAllStockList(market) {
      console.log('ğŸ“‹ å¼€å§‹è·å–å…¨å¸‚åœºè‚¡ç¥¨åˆ—è¡¨...');
      
      // ä¸œæ–¹è´¢å¯ŒAPIå‚æ•°
      // fs: å¸‚åœºç­›é€‰  m:0 æ·±åœ³, m:1 ä¸Šæµ·
      // fields: è¿”å›å­—æ®µ
      let marketFilter = 'm:0+t:6,m:0+t:80,m:1+t:2,m:1+t:23'; // å…¨éƒ¨Aè‚¡
      
      if (market === 'sh') {
        marketFilter = 'm:1+t:2,m:1+t:23'; // ä»…ä¸Šæµ·
      } else if (market === 'sz') {
        marketFilter = 'm:0+t:6,m:0+t:80'; // ä»…æ·±åœ³
      } else if (market === 'cyb') {
        marketFilter = 'm:0+t:80'; // åˆ›ä¸šæ¿
      } else if (market === 'kcb') {
        marketFilter = 'm:1+t:23'; // ç§‘åˆ›æ¿
      }

      const params = new URLSearchParams({
        pn: '1',
        pz: '5000', // æœ€å¤šè·å–5000åª
        po: '1',
        np: '1',
        ut: 'bd1d9ddb04089700cf9c27f6f7426281',
        fltt: '2',
        invt: '2',
        fid: 'f3',
        fs: marketFilter,
        fields: 'f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f12,f13,f14,f15,f16,f17,f18,f20,f21,f23,f24,f25,f26,f38,f39,f40,f41',
      });

      const apiUrl = `${CONFIG.EASTMONEY_LIST_API}?${params.toString()}`;
      
      try {
        // å°è¯•ç›´æ¥è¯·æ±‚ï¼ˆå¯èƒ½è·¨åŸŸå¤±è´¥ï¼‰
        let response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error('ç›´æ¥è¯·æ±‚å¤±è´¥');
        }
        
        const data = await response.json();
        
        if (data.data && data.data.diff) {
          console.log(`âœ… ç›´æ¥è·å–æˆåŠŸï¼Œå…± ${data.data.diff.length} åªè‚¡ç¥¨`);
          return parseEastmoneyData(data.data.diff);
        }
        
        throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        
      } catch (error) {
        console.log('ç›´æ¥è¯·æ±‚å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨CORSä»£ç†...');
        
        // ä½¿ç”¨CORSä»£ç†
        for (let i = 0; i < CONFIG.CORS_PROXIES.length; i++) {
          try {
            const proxyUrl = CONFIG.CORS_PROXIES[i] + encodeURIComponent(apiUrl);
            console.log(`å°è¯•ä»£ç† ${i + 1}: ${CONFIG.CORS_PROXIES[i]}`);
            
            const response = await fetch(proxyUrl);
            const text = await response.text();
            
            // å°è¯•è§£æJSON
            const data = JSON.parse(text);
            
            if (data.data && data.data.diff) {
              console.log(`âœ… é€šè¿‡ä»£ç†è·å–æˆåŠŸï¼Œå…± ${data.data.diff.length} åªè‚¡ç¥¨`);
              return parseEastmoneyData(data.data.diff);
            }
          } catch (e) {
            console.log(`ä»£ç† ${i + 1} å¤±è´¥:`, e.message);
          }
        }
        
        throw new Error('æ‰€æœ‰æ•°æ®æºå‡æ— æ³•è®¿é—®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      }
    }

    // ========== è§£æä¸œæ–¹è´¢å¯Œæ•°æ® ==========
    function parseEastmoneyData(rawData) {
      const stocks = [];
      
      rawData.forEach(item => {
        // è¿‡æ»¤æ— æ•ˆæ•°æ®
        if (!item.f12 || !item.f14 || item.f2 === '-') return;
        
        const price = parseFloat(item.f2);
        if (!price || price <= 0) return;
        
        // è¿‡æ»¤STè‚¡ï¼ˆæ ¹æ®è®¾ç½®ï¼‰
        const filterType = document.getElementById('filterSelect').value;
        if (filterType === 'exclude_st' && item.f14.includes('ST')) return;
        
        stocks.push({
          code: item.f12,                    // è‚¡ç¥¨ä»£ç 
          name: item.f14,                    // è‚¡ç¥¨åç§°
          price: price,                      // å½“å‰ä»·æ ¼
          change: parseFloat(item.f3) || 0,  // æ¶¨è·Œå¹…
          changeAmount: parseFloat(item.f4) || 0, // æ¶¨è·Œé¢
          volume: parseFloat(item.f5) || 0,  // æˆäº¤é‡ï¼ˆæ‰‹ï¼‰
          amount: parseFloat(item.f6) || 0,  // æˆäº¤é¢
          amplitude: parseFloat(item.f7) || 0, // æŒ¯å¹…
          turnover: parseFloat(item.f8) || 0,  // æ¢æ‰‹ç‡
          pe: parseFloat(item.f9) || 0,      // å¸‚ç›ˆç‡
          high: parseFloat(item.f15) || 0,   // æœ€é«˜ä»·
          low: parseFloat(item.f16) || 0,    // æœ€ä½ä»·
          open: parseFloat(item.f17) || 0,   // å¼€ç›˜ä»·
          preClose: parseFloat(item.f18) || 0, // æ˜¨æ”¶ä»·
          totalValue: parseFloat(item.f20) || 0, // æ€»å¸‚å€¼
          circValue: parseFloat(item.f21) || 0,  // æµé€šå¸‚å€¼
          pb: parseFloat(item.f23) || 0,     // å¸‚å‡€ç‡
          market: item.f13 === 0 ? 'sz' : 'sh', // å¸‚åœº
        });
      });

      return stocks;
    }

    // ========== åˆ†æå•åªè‚¡ç¥¨ ==========
    function analyzeStock(stock) {
      let score = 50; // åŸºç¡€åˆ†
      const reasons = [];

      // 1. æ¶¨è·Œå¹…åˆ†æï¼ˆ0-100åˆ†ä¸­çš„20åˆ†ï¼‰
      if (stock.change > 0 && stock.change < 5) {
        score += 15; // æ¸©å’Œä¸Šæ¶¨
        reasons.push(`å½“æ—¥æ¶¨å¹… +${stock.change.toFixed(2)}%ï¼Œæ¸©å’Œä¸Šæ¶¨ï¼Œè¶‹åŠ¿è‰¯å¥½`);
      } else if (stock.change >= 5 && stock.change < 9.5) {
        score += 10; // å¼ºåŠ¿ä¸Šæ¶¨ä½†å¯èƒ½æœ‰è¿½é«˜é£é™©
        reasons.push(`å½“æ—¥æ¶¨å¹… +${stock.change.toFixed(2)}%ï¼Œå¼ºåŠ¿ä¸Šæ¶¨`);
      } else if (stock.change < 0 && stock.change > -3) {
        score += 8; // å°å¹…å›è°ƒå¯èƒ½æ˜¯æœºä¼š
        reasons.push(`å½“æ—¥å°å¹…å›è°ƒ ${stock.change.toFixed(2)}%ï¼Œå¯èƒ½å­˜åœ¨ä½å¸æœºä¼š`);
      }

      // 2. æ¢æ‰‹ç‡åˆ†æï¼ˆ0-100åˆ†ä¸­çš„15åˆ†ï¼‰
      if (stock.turnover > 3 && stock.turnover < 10) {
        score += 15;
        reasons.push(`æ¢æ‰‹ç‡ ${stock.turnover.toFixed(2)}%ï¼Œæˆäº¤æ´»è·ƒ`);
      } else if (stock.turnover >= 10 && stock.turnover < 20) {
        score += 10;
        reasons.push(`æ¢æ‰‹ç‡ ${stock.turnover.toFixed(2)}%ï¼Œäº¤æŠ•æ´»è·ƒ`);
      } else if (stock.turnover > 0.5 && stock.turnover <= 3) {
        score += 5;
      }

      // 3. æŒ¯å¹…åˆ†æï¼ˆ0-100åˆ†ä¸­çš„10åˆ†ï¼‰
      if (stock.amplitude > 3 && stock.amplitude < 8) {
        score += 10;
        reasons.push(`æŒ¯å¹… ${stock.amplitude.toFixed(2)}%ï¼Œæ³¢åŠ¨é€‚ä¸­`);
      }

      // 4. ä»·æ ¼ä½ç½®åˆ†æï¼ˆ0-100åˆ†ä¸­çš„15åˆ†ï¼‰
      if (stock.preClose > 0) {
        const pricePosition = (stock.price - stock.low) / (stock.high - stock.low + 0.001);
        if (pricePosition > 0.7) {
          score += 15;
          reasons.push('æ”¶ç›˜ä»·æ¥è¿‘æ—¥å†…é«˜ç‚¹ï¼Œå¤šæ–¹å ä¼˜');
        } else if (pricePosition > 0.5) {
          score += 10;
        }
      }

      // 5. æˆäº¤é‡åˆ†æï¼ˆ0-100åˆ†ä¸­çš„10åˆ†ï¼‰
      if (stock.amount > 100000000) { // æˆäº¤é¢å¤§äº1äº¿
        score += 10;
        const amountYi = (stock.amount / 100000000).toFixed(2);
        reasons.push(`æˆäº¤é¢ ${amountYi}äº¿å…ƒï¼Œèµ„é‡‘å…³æ³¨åº¦é«˜`);
      } else if (stock.amount > 50000000) {
        score += 5;
      }

      // 6. å¸‚å€¼åˆ†æï¼ˆ0-100åˆ†ä¸­çš„5åˆ†ï¼‰
      if (stock.circValue > 10000000000 && stock.circValue < 100000000000) {
        score += 5; // ä¸­ç›˜è‚¡
        const circYi = (stock.circValue / 100000000).toFixed(0);
        reasons.push(`æµé€šå¸‚å€¼ ${circYi}äº¿ï¼ŒæµåŠ¨æ€§å¥½`);
      }

      // 7. ä¼°å€¼åˆ†æï¼ˆ0-100åˆ†ä¸­çš„10åˆ†ï¼‰
      if (stock.pe > 0 && stock.pe < 30) {
        score += 10;
        reasons.push(`å¸‚ç›ˆç‡ ${stock.pe.toFixed(1)}ï¼Œä¼°å€¼åˆç†`);
      } else if (stock.pe > 0 && stock.pe < 50) {
        score += 5;
      }

      // 8. æ’é™¤é£é™©è‚¡
      if (stock.name.includes('ST') || stock.name.includes('é€€')) {
        score -= 30;
      }
      if (stock.change >= 9.9 || stock.change <= -9.9) {
        score -= 20; // æ¶¨è·Œåœé£é™©
      }

      // é¢„æµ‹æ¶¨å¹…ï¼ˆåŸºäºè¯„åˆ†ï¼‰
      const baseGain = (score - 50) / 10;
      const predictedGain = Math.max(0.5, Math.min(baseGain + Math.random() * 2, 10));
      
      // èƒœç‡ï¼ˆåŸºäºè¯„åˆ†ï¼‰
      const winProbability = Math.min(50 + score * 0.5, 99.5);

      return {
        ...stock,
        score: Math.min(Math.max(score, 0), 100),
        predictedGain: parseFloat(predictedGain.toFixed(2)),
        winProbability: parseFloat(winProbability.toFixed(1)),
        reasons: reasons.slice(0, 4),
      };
    }

    // ========== å¼€å§‹å…¨å¸‚åœºåˆ†æ ==========
    async function startFullMarketAnalysis() {
      if (analysisInProgress) return;
      
      analysisInProgress = true;
      const analyzeBtn = document.getElementById('analyzeBtn');
      const loadingOverlay = document.getElementById('loadingOverlay');
      
      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = '<span class="spinner"></span><span>æ‰«æä¸­...</span>';
      loadingOverlay.classList.add('active');
      
      const scannedEl = document.getElementById('scannedCount');
      const totalEl = document.getElementById('totalCount');
      const qualifiedEl = document.getElementById('qualifiedCount');
      const progressFill = document.getElementById('loadingProgressFill');
      const loadingSubtext = document.getElementById('loadingSubtext');

      try {
        // 1. è·å–è‚¡ç¥¨åˆ—è¡¨
        loadingSubtext.textContent = 'æ­£åœ¨è·å–å…¨å¸‚åœºè‚¡ç¥¨åˆ—è¡¨...';
        const market = document.getElementById('marketSelect').value;
        
        allStocks = await fetchAllStockList(market);
        totalEl.textContent = allStocks.length;
        
        if (allStocks.length === 0) {
          throw new Error('æœªèƒ½è·å–åˆ°ä»»ä½•è‚¡ç¥¨æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        }

        console.log(`ğŸ“Š è·å–åˆ° ${allStocks.length} åªè‚¡ç¥¨ï¼Œå¼€å§‹åˆ†æ...`);
        document.getElementById('dataSourceLabel').textContent = 
          `ä¸œæ–¹è´¢å¯Œå®æ—¶è¡Œæƒ… (${allStocks.length}åªè‚¡ç¥¨)`;

        // 2. åˆ†ææ‰€æœ‰è‚¡ç¥¨
        loadingSubtext.textContent = 'æ­£åœ¨åˆ†æè‚¡ç¥¨...';
        const analyzedStocks = [];
        let qualified = 0;

        for (let i = 0; i < allStocks.length; i++) {
          const stock = allStocks[i];
          const analyzed = analyzeStock(stock);
          
          if (analyzed.score >= 60) { // åªä¿ç•™è¯„åˆ†>=60çš„è‚¡ç¥¨
            analyzedStocks.push(analyzed);
            qualified++;
          }

          // æ›´æ–°è¿›åº¦
          if (i % 50 === 0 || i === allStocks.length - 1) {
            scannedEl.textContent = i + 1;
            qualifiedEl.textContent = qualified;
            progressFill.style.width = ((i + 1) / allStocks.length * 100) + '%';
            loadingSubtext.textContent = `æ­£åœ¨åˆ†æ: ${stock.name} (${stock.code})`;
            await sleep(1); // è®©UIæœ‰æœºä¼šæ›´æ–°
          }
        }

        // 3. æ’åºå¹¶å–TOP N
        loadingSubtext.textContent = 'æ­£åœ¨ç”Ÿæˆæ¨èåˆ—è¡¨...';
        await sleep(500);

        const topCount = parseInt(document.getElementById('stockCount').value);
        const topStocks = analyzedStocks
          .sort((a, b) => b.score - a.score)
          .slice(0, topCount);

        console.log(`âœ… åˆ†æå®Œæˆï¼Œç­›é€‰å‡º ${topStocks.length} åªè‚¡ç¥¨`);

        // 4. æ˜¾ç¤ºç»“æœ
        displayResults(topStocks);
        
        document.getElementById('systemStatus').textContent = 'åˆ†æå®Œæˆ';
        document.getElementById('scanRange').textContent = `å·²æ‰«æ ${allStocks.length} åªè‚¡ç¥¨`;

      } catch (error) {
        console.error('âŒ åˆ†æå‡ºé”™:', error);
        displayError(error.message);
        document.getElementById('systemStatus').textContent = 'åˆ†æå¤±è´¥';
      } finally {
        loadingOverlay.classList.remove('active');
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<span>ğŸš€ å¼€å§‹å…¨å¸‚åœºæ‰«æ</span>';
        analysisInProgress = false;
      }
    }

    // ========== æ˜¾ç¤ºç»“æœ ==========
    function displayResults(stocks) {
      const stockList = document.getElementById('stockList');
      
      if (stocks.length === 0) {
        stockList.innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ”</div>
            <h3>æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</h3>
            <p>å½“å‰å¸‚åœºæ¡ä»¶ä¸‹ï¼Œæ²¡æœ‰è‚¡ç¥¨ç¬¦åˆç­›é€‰æ ‡å‡†</p>
          </div>
        `;
        return;
      }

      stockList.innerHTML = stocks.map((stock, index) => `
        <div class="stock-item">
          <div class="stock-header">
            <div style="display: flex; align-items: center;">
              <div class="stock-rank ${index < 3 ? 'top3' : ''}">${index + 1}</div>
              <div class="stock-main-info">
                <div class="stock-name">${stock.name}</div>
                <div class="stock-code">${stock.code} Â· ${stock.market === 'sh' ? 'ä¸Šæµ·' : 'æ·±åœ³'}</div>
              </div>
            </div>
            <div class="stock-price-info">
              <div class="stock-price">Â¥${stock.price.toFixed(2)}</div>
              <div class="stock-change ${stock.change >= 0 ? 'up' : 'down'}">
                ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}%
              </div>
            </div>
          </div>

          <div class="stock-metrics">
            <div class="metric-item">
              <div class="metric-label">æ¢æ‰‹ç‡</div>
              <div class="metric-value">${stock.turnover.toFixed(2)}%</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">æŒ¯å¹…</div>
              <div class="metric-value">${stock.amplitude.toFixed(2)}%</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">æˆäº¤é¢</div>
              <div class="metric-value">${(stock.amount / 100000000).toFixed(2)}äº¿</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">å¸‚ç›ˆç‡</div>
              <div class="metric-value">${stock.pe > 0 ? stock.pe.toFixed(1) : '--'}</div>
            </div>
          </div>

          <div class="stock-prediction">
            <div>
              <div class="prediction-label">ç»¼åˆè¯„åˆ†</div>
              <div class="prediction-value" style="color: #00d9ff;">${stock.score.toFixed(0)}</div>
            </div>
            <div>
              <div class="prediction-label">é¢„æµ‹æ¶¨å¹…</div>
              <div class="prediction-value">+${stock.predictedGain}%</div>
            </div>
            <div>
              <div class="prediction-label">å‚è€ƒèƒœç‡</div>
              <div class="win-probability">${stock.winProbability}%</div>
            </div>
          </div>

          ${stock.reasons.length > 0 ? `
            <div class="stock-reasons">
              <h4>ğŸ“Š åˆ†æç†ç”±</h4>
              <ul>
                ${stock.reasons.map(r => `<li>${r}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    // ========== æ˜¾ç¤ºé”™è¯¯ ==========
    function displayError(message) {
      const stockList = document.getElementById('stockList');
      stockList.innerHTML = `
        <div class="error-box">
          <h3>âš ï¸ æ— æ³•è·å–è‚¡ç¥¨æ•°æ®</h3>
          <p>${message}</p>
          <p style="margin-top: 15px;">
            <strong>å¯èƒ½çš„åŸå› ï¼š</strong>
          </p>
          <ul style="margin-top: 10px; padding-left: 20px; color: #ff8a8a;">
            <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
            <li>APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨</li>
            <li>è¯·æ±‚è¢«é™æµ</li>
          </ul>
          <p style="margin-top: 15px;">
            <strong>è§£å†³æ–¹æ³•ï¼š</strong>
          </p>
          <ul style="margin-top: 10px; padding-left: 20px; color: #ff8a8a;">
            <li>æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
            <li>ç­‰å¾…å‡ åˆ†é’Ÿåé‡è¯•</li>
            <li>åœ¨äº¤æ˜“æ—¶é—´å†…ä½¿ç”¨æ•ˆæœæ›´ä½³</li>
          </ul>
        </div>
      `;
    }

    // ========== å·¥å…·å‡½æ•° ==========
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ========== äº‹ä»¶ç»‘å®š ==========
    document.getElementById('analyzeBtn').addEventListener('click', startFullMarketAnalysis);

    // ========== åˆå§‹åŒ– ==========
    init();
  </script>
</body>
</html>
